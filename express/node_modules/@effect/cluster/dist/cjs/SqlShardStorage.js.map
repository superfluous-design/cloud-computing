{"version":3,"file":"SqlShardStorage.js","names":["SqlClient","_interopRequireWildcard","require","Arr","Effect","Layer","_ClusterError","ShardStorage","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","withTracerDisabled","withTracerEnabled","make","exports","fnUntraced","options","sql","withoutTransforms","prefix","table","name","runnersTable","runnersTableSql","onDialectOrElse","mssql","mysql","pg","orElse","shardsTable","shardsTableSql","locksTable","locksTableSql","sqlNowString","sqlNow","literal","lockExpiresAt","acquireLock","address","values","csv","_address","unprepared","forUpdate","sqlite","makeEncoded","getAssignments","pipe","PersistenceError","refail","saveAssignments","assignments","remove","length","map","shardId","andThen","withTransaction","getRunners","runner","String","saveRunners","runners","insert","acquire","shardIds","currentLocks","in","row","shard_id","refresh","rows","Number","release","releaseAll","layer","effect","layerWith","scoped"],"sources":["../../src/SqlShardStorage.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}