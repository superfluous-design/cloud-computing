{"version":3,"file":"SqlShardStorage.js","names":["SqlClient","Arr","Effect","Layer","PersistenceError","ShardStorage","withTracerDisabled","withTracerEnabled","make","fnUntraced","options","sql","withoutTransforms","prefix","table","name","runnersTable","runnersTableSql","onDialectOrElse","mssql","mysql","pg","orElse","shardsTable","shardsTableSql","locksTable","locksTableSql","sqlNowString","sqlNow","literal","lockExpiresAt","acquireLock","address","values","csv","_address","unprepared","forUpdate","sqlite","makeEncoded","getAssignments","pipe","refail","saveAssignments","assignments","remove","length","map","shardId","andThen","withTransaction","getRunners","runner","String","saveRunners","runners","insert","acquire","shardIds","currentLocks","in","row","shard_id","refresh","rows","Number","release","releaseAll","layer","effect","layerWith","scoped"],"sources":["../../src/SqlShardStorage.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}