{"version":3,"file":"SqlEventJournal.js","names":["EventJournal","_interopRequireWildcard","require","Effect","Layer","PubSub","Schema","Uuid","SqlClient","SqlSchema","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","make","options","gen","sql","entryTable","remotesTable","onDialectOrElse","pg","withoutTransform","mysql","mssql","orElse","EntrySqlEncoded","EntrySqlPg","EntrySqlSqlite","EntrySql","transform","Entry","decode","fromA","id","event","primaryKey","primary_key","payload","encode","toI","timestamp","Date","entryIdMillis","EntrySqlArray","Array","decodeEntrySqlArray","decodeUnknown","insertEntry","void","Request","execute","entry","insert","insertEntries","insertRemotes","RemoteSql","pubsub","unbounded","of","entries","pipe","flatMap","mapError","cause","EventJournalError","method","write","effect","makeEntryId","disableValidation","value","publish","withTransaction","writeFromRemote","remotes","remoteEntry","push","remote_id","remoteId","entry_id","sequence","remoteSequence","existingIds","Set","in","map","tap","rows","row","add","stringify","uncommited","filter","idString","brackets","compact","_","compacted","length","conflicts","createdAtMillis","withRemoteUncommited","nextRemoteSequence","Number","max","changes","subscribe","destroy","exports","layer","Struct","Uint8ArrayFromSelf","String","DateFromSelf","DateFromNumber","RemoteId","EntryId"],"sources":["../../src/SqlEventJournal.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}