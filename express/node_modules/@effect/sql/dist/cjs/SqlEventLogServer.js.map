{"version":3,"file":"SqlEventLogServer.js","names":["_EventJournal","require","_EventLogEncryption","EventLogServer","_interopRequireWildcard","Chunk","Effect","_Function","Layer","Mailbox","PubSub","RcMap","Schema","SqlClient","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","makeStorage","options","gen","encryptions","EventLogEncryption","sql","tablePrefix","entryTablePrefix","remoteIdTable","insertBatchSize","onDialectOrElse","pg","withoutTransform","mysql","mssql","orElse","remoteId","pipe","flatMap","results","length","succeed","RemoteId","make","remote_id","newRemoteId","makeRemoteId","as","resources","lookup","publicKey","publicKeyHash","sha256String","TextEncoder","encode","slice","table","pubsub","acquireRelease","unbounded","shutdown","idleTimeToLive","Storage","of","getId","write","entries","forInsert","ids","currentBatch","entry","push","entryId","iv","entry_id","encrypted_entry","encryptedEntry","allEntries","batch","encryptedEntries","insert","zipRight","in","decodeEntries","offerAll","orDie","scoped","startSequence","changes","mailbox","queue","subscribe","initial","takeBetween","Number","MAX_SAFE_INTEGER","tap","chunk","filter","_","sequence","forever","forkScoped","interruptible","exports","EncryptedRemoteEntrySql","Struct","Uint8ArrayFromSelf","EncryptedRemoteEntryFromSql","transform","EncryptedRemoteEntry","decode","fromA","toI","decodeUnknown","Array","layerStorage","layerStorageSubtle","provide","layerSubtle"],"sources":["../../src/SqlEventLogServer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}