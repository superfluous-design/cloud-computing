{"version":3,"file":"SqlEventLogServer.js","names":["makeRemoteId","RemoteId","EncryptedRemoteEntry","EventLogEncryption","layerSubtle","EventLogServer","Chunk","Effect","pipe","Layer","Mailbox","PubSub","RcMap","Schema","SqlClient","makeStorage","options","gen","encryptions","sql","tablePrefix","entryTablePrefix","remoteIdTable","insertBatchSize","onDialectOrElse","pg","withoutTransform","mysql","mssql","orElse","remoteId","flatMap","results","length","succeed","make","remote_id","newRemoteId","as","resources","lookup","publicKey","publicKeyHash","sha256String","TextEncoder","encode","slice","table","pubsub","acquireRelease","unbounded","shutdown","idleTimeToLive","Storage","of","getId","write","entries","get","forInsert","ids","currentBatch","entry","push","entryId","iv","entry_id","encrypted_entry","encryptedEntry","allEntries","batch","encryptedEntries","insert","zipRight","in","decodeEntries","offerAll","orDie","scoped","startSequence","changes","mailbox","queue","subscribe","initial","takeBetween","Number","MAX_SAFE_INTEGER","tap","chunk","filter","_","sequence","forever","forkScoped","interruptible","EncryptedRemoteEntrySql","Struct","Uint8ArrayFromSelf","EncryptedRemoteEntryFromSql","transform","decode","fromA","toI","decodeUnknown","Array","layerStorage","layerStorageSubtle","provide"],"sources":["../../src/SqlEventLogServer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}